name: "CI - Stage 3 - DAST Security Scanning"

on:
  push:
    branches:
      - main
      - "feature/**"
  workflow_dispatch:
    inputs:
      target_url:
        description: "URL of the deployed application to scan"
        required: true
        default: "http://localhost:5002"

jobs:
  dast-scan:
    name: ğŸ” DAST Security Scan with ZAP
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§° Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: ğŸ“¦ Restore Dependencies
        run: dotnet restore

      - name: ğŸš€ Run Application for Testing
        run: |
          dotnet build
          dotnet run --project UserManagement/UserManagement.csproj --urls=http://localhost:5002 &
          echo "Waiting for API to start..."
          sleep 10
          # Verify app is running
          curl -s -o /dev/null -w "%{http_code}" http://localhost:5002/healthz || echo "Service may not be fully started"

      - name: ğŸ”’ Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.9.0
        with:
          target: "http://localhost:5002"
          cmd_options: "-a"
          fail_action: false # Don't fail workflow on alerts
          
      - name: â¬† Upload DAST Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-results
          path: |
            report_html.html
