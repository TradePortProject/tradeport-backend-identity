name: "CI - Stage 3 - DAST Security Scanning"

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: "URL of the deployed application to scan"
        required: true
        default: "http://localhost:5000"

jobs:
  dast-scan:
    name: 🔍 Dynamic Application Security Testing
    runs-on: ubuntu-latest

    steps:
      - name: 🧾 Checkout Repository
        uses: actions/checkout@v4

      # ✅ Create ZAP Rules File *before* scan
      - name: 📝 Create ZAP Rules File
        run: |
          mkdir -p .zap
          echo "# rules.tsv" > .zap/rules.tsv

      # ✅ Build and Run the App (you can replace this with Docker)
      - name: 🚀 Run .NET App Locally
        run: |
          nohup dotnet run --project UserManagement/UserManagement.csproj --urls=http://0.0.0.0:5000 &
          sleep 15
          curl -s http://localhost:5000 || true

      # ✅ Run OWASP ZAP scan (now with rule file ready)
      - name: 🔒 Run OWASP ZAP Scan
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: "http://localhost:5000"
          rules_file_name: ".zap/rules.tsv"
          cmd_options: "-a -j"
          allow_issue_writing: false
          fail_action: false

      # ✅ Generate HTML Report
      - name: 📊 Generate HTML Report
        run: |
          mkdir -p dast-results
          cat report_html.html > dast-results/zap-report.html

      # ✅ Upload Artifact
      - name: ⬆ Upload DAST Results
        uses: actions/upload-artifact@v4
        with:
          name: dast-scan-results
          path: dast-results/
